<template>
  <div class="background">
    <div class="section-wrapper" :style="{ backgroundImage: `url(${backgroundImage})` }">
      <section class="middle-section">
        <div class="login-wrapper">
          <svg class="easyways-logo" xmlns="http://www.w3.org/2000/svg" height="75" viewBox="0 0 163.425 63.701">
            <g id="Group_3" data-name="Group 3" transform="translate(-3856.305 1453.6)">
              <g id="Group_2" data-name="Group 2" transform="translate(3878.191 -1426.885)">
                <path
                  id="Path_2"
                  data-name="Path 2"
                  class="cls-1"
                  d="M3885.532-1423.346a6.886,6.886,0,0,1-6.118,4,5.819,5.819,0,0,1-5.981-5.98,7.345,7.345,0,0,1,7.176-7.372,5.53,5.53,0,0,1,5.7,5.786,4.686,4.686,0,0,1-.473,2.143h-8.679a2.459,2.459,0,0,0,2.56,1.974,2.576,2.576,0,0,0,1.836-.863Zm-8.037-3.783h5.285a2.186,2.186,0,0,0-2.282-2.085A3.367,3.367,0,0,0,3877.5-1427.13Z"
                  transform="translate(-3873.433 1432.693)"></path>
                <path
                  id="Path_3"
                  data-name="Path 3"
                  class="cls-1"
                  d="M3896.385-1427.881a9.083,9.083,0,0,1-.111,1.169l-1.251,7.093h-2.782l-.362-1.252a6.737,6.737,0,0,1-3.7,1.391c-2.616,0-3.951-1.558-3.951-3.339,0-2.558,1.78-4.589,8.4-4.589a1.535,1.535,0,0,0-1.529-1.947,2.089,2.089,0,0,0-1.78,1.251l-3.755-.277a5.916,5.916,0,0,1,5.73-4.312C3894.326-1432.693,3896.385-1430.8,3896.385-1427.881Zm-4.255,3.255.111-.556c-3.645,0-4.229.834-4.229,1.78a1.233,1.233,0,0,0,1.335,1.141A2.83,2.83,0,0,0,3892.13-1424.626Z"
                  transform="translate(-3870.434 1432.693)"></path>
                <path
                  id="Path_4"
                  data-name="Path 4"
                  class="cls-1"
                  d="M3898.38-1423.792a1.426,1.426,0,0,0,1.612,1.392c.891,0,1.5-.5,1.5-1.057,0-1.224-5.619-1.252-5.619-5.008,0-2.225,1.835-4.228,4.9-4.228,3.81,0,5.34,2.032,5.368,3.895l-3.56.279c-.057-.584-.612-1.113-1.558-1.113-.751,0-1.252.39-1.252.946,0,1.2,5.59,1.252,5.59,4.979,0,2.253-1.946,4.366-5.2,4.366-3.782,0-5.174-1.946-5.4-4.172Z"
                  transform="translate(-3867.508 1432.693)"></path>
                <path
                  id="Path_5"
                  data-name="Path 5"
                  class="cls-1"
                  d="M3904.945-1432.475h4.034l1.39,7.816,4.172-7.816h4.256l-7.677,13.24c-1.668,2.893-3.2,4.145-5.312,4.145a6.88,6.88,0,0,1-1.641-.279l.556-3.143h.39a2.57,2.57,0,0,0,2.56-1.725Z"
                  transform="translate(-3864.896 1432.754)"></path>
                <path
                  id="Path_6"
                  data-name="Path 6"
                  class="cls-1"
                  d="M3913.918-1423.392a2.334,2.334,0,0,1,2.252-2.226,1.924,1.924,0,0,1,1.891,1.947,2.333,2.333,0,0,1-2.252,2.226A1.924,1.924,0,0,1,3913.918-1423.392Z"
                  transform="translate(-3862.187 1434.658)"></path>
                <path
                  id="Path_7"
                  data-name="Path 7"
                  class="cls-1"
                  d="M3927.822-1432.475h2.5l1.03,7.4,3.477-7.4h3.978l-6.565,12.8h-3.2l-.974-7.093-3.477,7.093h-3.2l-2.059-12.8h3.812l.917,7.4Z"
                  transform="translate(-3860.682 1432.754)"></path>
                <path
                  id="Path_8"
                  data-name="Path 8"
                  class="cls-1"
                  d="M3946.229-1427.881a9.083,9.083,0,0,1-.111,1.169l-1.252,7.093h-2.782l-.361-1.252a6.732,6.732,0,0,1-3.7,1.391c-2.615,0-3.95-1.558-3.95-3.339,0-2.558,1.78-4.589,8.4-4.589a1.535,1.535,0,0,0-1.529-1.947,2.089,2.089,0,0,0-1.78,1.251l-3.755-.277a5.916,5.916,0,0,1,5.73-4.312C3944.17-1432.693,3946.229-1430.8,3946.229-1427.881Zm-4.256,3.255.111-.556c-3.644,0-4.228.834-4.228,1.78a1.233,1.233,0,0,0,1.335,1.141A2.827,2.827,0,0,0,3941.972-1424.626Z"
                  transform="translate(-3856.589 1432.693)"></path>
                <path
                  id="Path_9"
                  data-name="Path 9"
                  class="cls-1"
                  d="M3945.322-1432.475h4.033l1.391,7.816,4.172-7.816h4.254l-7.677,13.24c-1.668,2.893-3.2,4.145-5.313,4.145a6.885,6.885,0,0,1-1.641-.279l.557-3.143h.389a2.568,2.568,0,0,0,2.559-1.725Z"
                  transform="translate(-3853.68 1432.754)"></path>
                <path
                  id="Path_10"
                  data-name="Path 10"
                  class="cls-1"
                  d="M3958.889-1423.792a1.426,1.426,0,0,0,1.612,1.392c.891,0,1.5-.5,1.5-1.057,0-1.224-5.62-1.252-5.62-5.008,0-2.225,1.836-4.228,4.9-4.228,3.81,0,5.341,2.032,5.368,3.895l-3.56.279c-.056-.584-.612-1.113-1.558-1.113-.751,0-1.252.39-1.252.946,0,1.2,5.591,1.252,5.591,4.979,0,2.253-1.947,4.366-5.2,4.366-3.784,0-5.174-1.946-5.4-4.172Z"
                  transform="translate(-3850.699 1432.693)"></path>
              </g>
              <path
                id="Path_11"
                data-name="Path 11"
                class="cls-1"
                d="M4019.73-1389.9H3856.305v-63.7H4019.73Zm-158.324-5.1h153.223v-53.5H3861.406Z"
                transform="translate(0)"></path>
            </g>
          </svg>
          <div v-for="(error, index) in errorList" :key="index" class="error-message">
            <p v-if="error.active" class="error-color">
              {{ error.message }}
            </p>
          </div>
          <input
            v-if="state === stateTypes.EMAIL"
            :value="email"
            @input="e => email = e.target.value"
            @blur="validateEmail(email)"
            type="text"
            placeholder="Email"
            @keyup.enter="checkForExistingEmail">
          <input
            v-if="state === stateTypes.PASSWORD"
            type="password"
            :value="password"
            @input="e => password = e.target.value"
            @blur="validatePassword(password)"
            class="password"
            placeholder="Password"
            @keyup.enter="login">
          <input
            v-if="state === stateTypes.NEWPASSWORD"
            :value="newPassword"
            @input="e => newPassword = e.target.value"
            @blur="validatePassword(newPassword)"
            class="newPassword"
            type="password"
            placeholder="New Password">
          <input
            v-if="state === stateTypes.NEWPASSWORD"
            :value="repeatNewPassword"
            @input="e => repeatNewPassword = e.target.value"
            @keyup.enter="createPassword(newPassword, repeatNewPassword)"
            @blur="validateRepeatPassword(repeatNewPassword)"
            class="repeatPassword"
            type="password"
            placeholder=" Repeat Password">
          <div v-if="state === stateTypes.EMAIL" class="submit-button" type="button" @click="checkForExistingEmail()">
            Next
          </div>
          <div
            v-if="state !== stateTypes.EMAIL"
            class="submit-button"
            type="button"
            v-on="state === stateTypes.NEWPASSWORD ? { click: () => createPassword(newPassword, repeatNewPassword) } : {click: () => login(password) }">
            Login
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script>
import crypto from 'crypto-js';
import { setCookie, setCookieUnparsed } from '~/helpers/cookies.js';
import backgroundImage from '~/assets/images/loginBackground.jpg';
export default {
  data () {
    const stateTypes = {
      EMAIL: 'email',
      PASSWORD: 'password',
      NEWPASSWORD: 'newPassword'
    };
    const errorList = [{
      message: '*Invalid Email',
      active: false
    },
    {
      message: '*Invalid Password',
      active: false
    },
    {
      message: '*Passwords don\'t match',
      active: false
    },
    {
      message: '*Password is incorrect for this account',
      active: false
    },
    {
      message: '*User already logged in',
      active: false
    },
    {
      message: 'This email doesn\'t have an account',
      active: false
    }
    ];
    return {
      backgroundImage,
      state: 'email',
      stateTypes,
      email: '',
      password: '',
      newPassword: '',
      repeatNewPassword: '',
      id: 0,
      errorList
    };
  },
  beforeMount () {
    if (this.$store.state.user.id) {
      this.$router.push('/employee');
    }
  },
  methods: {
    async checkForExistingEmail () {
      this.errorList[5].active = false;
      try {
        if (this.validateEmail(this.email)) {
          const res = await this.$axios.get(`${process.env.BASE_URL}/Login/check-email?email=` + this.email);
          if (res.data.error) {
            this.errorList[5].active = true;
            return;
          }
          this.state = res.data.hasLogin ? this.stateTypes.PASSWORD : this.stateTypes.NEWPASSWORD;
        }
      } catch (e) {
        console.log(e);
      }
    },
    async login (password) {
      this.errorList[3].active = false;
      try {
        if (this.validatePassword(password) && this.email) {
          const res = await this.$axios.get(`${process.env.BASE_URL}/Login/login?password=` + this.password + '&email=' + this.email);
          if (res.data.error) {
            this.errorList[3].active = true;
          } else {
            setCookieUnparsed('session', res.data.cookie);
            const decodeCookie = JSON.parse(crypto.enc.Base64.parse(res.data.cookie).toString(crypto.enc.Utf8));
            const user = { email: this.email, name: decodeCookie.Name, id: decodeCookie.Id, token: decodeCookie.Token, role: decodeCookie.Role };
            setCookie('easybeauty_user', user);
            this.$store.dispatch('user/userLoggedIn', user);
            window.location.href = '/employee';
          }
        }
      } catch (e) {
        console.log(e);
      }
    },
    async createPassword (newPassword, repeatedPassword) {
      try {
        if (this.validatePassword(newPassword) && this.validateRepeatPassword(repeatedPassword)) {
          const res = await this.$axios.put(`${process.env.BASE_URL}/Login/create-password?email=` + this.email + '&password=' + newPassword + '&repeatedPassword=' + repeatedPassword);
          if (res.data.success) {
            this.state = this.stateTypes.PASSWORD;
          } else if (res.data.error) {
            this.errorList[1].active = true;
          }
        }
      } catch (e) {
        console.log(e);
      }
    },
    validateEmail (email) {
      this.errorList[0].active = false;
      if (email === '' || !this.email.match(
        /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
      )) {
        this.errorList[0].active = true;
        return false;
      } else {
        this.errorList[0].active = false;
        return true;
      }
    },
    validatePassword (password) {
      this.errorList[1].active = false;
      if (/\s$/.test(password) || password === '' || password.length < 6) {
        this.errorList[1].active = true;
        return false;
      } else {
        this.errorList[1].active = false;
        return true;
      }
    },
    validateRepeatPassword (password) {
      this.errorList[2].active = false;
      if (password !== this.newPassword) {
        this.errorList[2].active = true;
        return false;
      } else {
        this.errorList[2].active = false;
        return true;
      }
    }
  }
};

</script>

<style lang="scss" scoped>
.background {
  font-family: bureau-grot, sans-serif;
  background-size: cover;
}

.section-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
  position: absolute;
  left: 0;
  top: 0;
  justify-content: center;
}

.section-wrapper section {
  display: flex;
}

.middle-section {
  height: 60%;
}

/* LOGIN */
.login-wrapper {
  margin: auto;
  display: flex;
  flex-direction: column;
  padding: 40px;
  color: white;
}

.login-wrapper > .easyways-logo {
  fill: white;
  margin: auto auto 40px auto;
}

.login-wrapper > .error-message {
  color: #fff;
}

.login-wrapper input {
  padding: 15px;
  border-radius: 6px;
  margin: 5px auto 5px auto;
  width: 250px;
}

.login-wrapper > .submit-button {
  margin: 10px auto auto auto;
  background-color: lightseagreen;
  padding: 15px 40px;
  display: flex;
  justify-content: center;
  border-radius: 6px;
  font-weight: 400;
  cursor: pointer;
}
.error-color {
  color: crimson;
}
</style>
